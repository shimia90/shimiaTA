<?php
declare(strict_types = 1);

include __DIR__.'/basics.php';
include __DIR__.'/functions.php';

use React\EventLoop\Factory;
use unreal4u\TelegramAPI\HttpClientRequestHandler;
use unreal4u\TelegramAPI\Telegram\Methods\SendMessage;
use unreal4u\TelegramAPI\Telegram\Methods\AnswerCallbackQuery;
use unreal4u\TelegramAPI\Telegram\Methods\EditMessageText;
use unreal4u\TelegramAPI\Telegram\Types\Inline\Keyboard\Markup;
use unreal4u\TelegramAPI\Telegram\Types\User;
use unreal4u\TelegramAPI\TgLog;

$loop 			= 	Factory::create();
$tgLog 			= 	new TgLog(BOT_TOKEN, new HttpClientRequestHandler($loop));

$sendMessage 	= 	new SendMessage();

$step           =   getData('step-'.A_USER_CHAT_ID);
$verified       =   setData('verified','no');

  switch ($text) {
    case '/start':
      setData('step-'.A_USER_CHAT_ID,'1');
      $sendMessage->chat_id = A_USER_CHAT_ID;
      $sendMessage->text = 'Vui l√≤ng nh·∫≠p Username c·ªßa b·∫°n:';
      break;
    case '/huy':
      setData('step-'.A_USER_CHAT_ID,'0');
      $sendMessage->chat_id = A_USER_CHAT_ID;
      $sendMessage->text = 'Th√¥ng tin ƒë√£ h·ªßy ! Vui l√≤ng nh·∫•n /start ƒë·ªÉ ƒëƒÉng nh·∫≠p l·∫°i';
      break;
    case '/dangky':
      
      break;
    case $nutYeuCau[0]:
      require_once __DIR__.'/types/inline_keyboard_plans.php';
      break;
    case $nutYeuCau[1]:
      require_once __DIR__.'/types/yeu_cau_tuan.php';
      break;
    case $nutYeuCau[2]:
      require_once __DIR__.'/types/yeu_cau_thang.php';
      break;
    default:
      switch ($step) {
        case '1':
          setData('username-'.A_USER_CHAT_ID,$text);
          $sendMessage->chat_id = A_USER_CHAT_ID;
          $sendMessage->text = 'Vui l√≤ng nh·∫≠p Password c·ªßa b·∫°n:';
          setData('step-'.A_USER_CHAT_ID,'2');
          break;
        case '2':
          setData('password-'.A_USER_CHAT_ID, $text);
          $username   =   getData('username-'.A_USER_CHAT_ID);
          $password   =   getData('password-'.A_USER_CHAT_ID);
          if(checkLogin($username, $password) == true) {
          	insertTelegramId($username, A_USER_CHAT_ID);
            require_once __DIR__.'/types/init_keyboards.php';
            removeData('username-'.A_USER_CHAT_ID);
            removeData('password-'.A_USER_CHAT_ID);
            setData('step-'.A_USER_CHAT_ID,'0');
            setData('verified','yes');
          } else {
            $sendMessage->chat_id = A_USER_CHAT_ID;
            $sendMessage->text = 'ƒêƒÉng nh·∫≠p kh√¥ng th√†nh c√¥ng ! Vui l√≤ng nh·∫•n /start ƒë·ªÉ ƒëƒÉng nh·∫≠p l·∫°i';
            setData('step-'.A_USER_CHAT_ID,'0');
            setData('verified','no');
          }
          break;
        default:
            $sendMessage->chat_id = A_USER_CHAT_ID;
            $sendMessage->text = 'Vui l√≤ng nh·∫•n /start ƒë·ªÉ ƒëƒÉng nh·∫≠p';
          break;
      }
      break;
  }

$promise = $tgLog->performApiRequest($sendMessage);

// Ki·ªÉm Tra Query
if(!empty($queryData)) {
$arrayQueryData     =   explode('_', $queryData);
$getQueryType       =   $arrayQueryData[0];
  switch ($getQueryType) {
    case 'print':
      $answerQueryText                            	  =     answerPlanDetail($queryUserId, $queryData);
      $answerCallbackQuery                        	  =     new AnswerCallbackQuery();
      $answerCallbackQuery->callback_query_id     	  =     $queryid;
      $answerCallbackQuery->show_alert            	  =     true;
      $answerCallbackQuery->text                  	  =     $answerQueryText;
      $messageCorrectionPromise                   	  =     $tgLog->performApiRequest($answerCallbackQuery);
      break;
    case 'request':
      $editMessageText                            	  =     new EditMessageText();
      $editMessageText->chat_id                   	  =     $queryUserId;
      $editMessageText->message_id                	  =     $querymsgId;
      $editMessageText->text                      	  =     "Vui l√≤ng ch·ªçn y√™u c·∫ßu cho Plan ".strtoupper($arrayQueryData[1]);
      $inlineKeyboard = new Markup([
          'inline_keyboard' => [
              [
                  ['text' => '‚úÖ C√≥', 'callback_data' => 'week_'.$arrayQueryData[1].'_yes'],
                  ['text' => '‚ùå Kh√¥ng', 'callback_data' => 'week_'.$arrayQueryData[1].'_no'],
              ],
              [
                  ['text' => 'üîô Quay L·∫°i', 'callback_data' => 'back_week'],
              ],
          ]
      ]);
      $editMessageText->reply_markup              	  =     $inlineKeyboard;

      $messageCorrectionPromise                   	  =     $tgLog->performApiRequest($editMessageText);
      break; // End y√™u c·∫ßu r√∫t tu·∫ßn
    case 'request-month':
      $editMessageText                            	  =     new EditMessageText();
      $editMessageText->chat_id                   	  =     $queryUserId;
      $editMessageText->message_id                	  =     $querymsgId;
      $editMessageText->text                      	  =     "Vui l√≤ng ch·ªçn y√™u c·∫ßu cho Plan ".strtoupper($arrayQueryData[1]);
      $inlineKeyboard = new Markup([
          'inline_keyboard' => [
              [
                  ['text' => 'üí∏ R√∫t L√£i', 'callback_data' => 'month_'.$arrayQueryData[1].'_rut-lai'],
                  ['text' => 'üí∞ R√∫t G·ªëc', 'callback_data' => 'month_'.$arrayQueryData[1].'_rut-goc'],
                  ['text' => '‚ùå H·ªßy Y√™u C·∫ßu', 'callback_data' => 'month_'.$arrayQueryData[1].'_huy'],
              ],
              [
                  ['text' => 'üîô Quay L·∫°i', 'callback_data' => 'back_month'],
              ],
          ]
      ]);
      $editMessageText->reply_markup              	  =     $inlineKeyboard;

      $messageCorrectionPromise                   	  =     $tgLog->performApiRequest($editMessageText);
      break; // End y√™u c·∫ßu r√∫t th√°ng
    case 'week':
      switch ($arrayQueryData[2]) {
        case 'yes':
          $answerQueryText                            =     updateRequestCoin($queryUserId, $arrayQueryData[1], 'c√≥', 'week');
          $answerCallbackQuery                        =     new AnswerCallbackQuery();
          $answerCallbackQuery->callback_query_id     =     $queryid;
          $answerCallbackQuery->show_alert            =     true;
          $answerCallbackQuery->text                  =     $answerQueryText;
          $messageCorrectionPromise                   =     $tgLog->performApiRequest($answerCallbackQuery);
          break;
        
        case 'no':
          $answerQueryText                            =     updateRequestCoin($queryUserId, $arrayQueryData[1], 'kh√¥ng', 'week');
          $answerCallbackQuery                        =     new AnswerCallbackQuery();
          $answerCallbackQuery->callback_query_id     =     $queryid;
          $answerCallbackQuery->show_alert            =     true;
          $answerCallbackQuery->text                  =     $answerQueryText;
          $messageCorrectionPromise                   =     $tgLog->performApiRequest($answerCallbackQuery);
          break;
      }
      break; // End Y√™u C·∫ßu T√°i R√∫t Tu·∫ßn
    case 'month':
      switch ($arrayQueryData[2]) {
        case 'rut-lai':
          $answerQueryText                            =     updateRequestCoin($queryUserId, $arrayQueryData[1], 'R√∫t L√£i', 'month');
          $answerCallbackQuery                        =     new AnswerCallbackQuery();
          $answerCallbackQuery->callback_query_id     =     $queryid;
          $answerCallbackQuery->show_alert            =     true;
          $answerCallbackQuery->text                  =     $answerQueryText;
          $messageCorrectionPromise                   =     $tgLog->performApiRequest($answerCallbackQuery);
          break;
        
        case 'rut-goc':
          $answerQueryText                            =     updateRequestCoin($queryUserId, $arrayQueryData[1], 'R√∫t G·ªëc', 'month');
          $answerCallbackQuery                        =     new AnswerCallbackQuery();
          $answerCallbackQuery->callback_query_id     =     $queryid;
          $answerCallbackQuery->show_alert            =     true;
          $answerCallbackQuery->text                  =     $answerQueryText;
          $messageCorrectionPromise                   =     $tgLog->performApiRequest($answerCallbackQuery);
          break;
        case 'huy':
          $answerQueryText                            =     updateRequestCoin($queryUserId, $arrayQueryData[1], 'Ch∆∞a c√≥ y√™u c·∫ßu', 'month');
          $answerCallbackQuery                        =     new AnswerCallbackQuery();
          $answerCallbackQuery->callback_query_id     =     $queryid;
          $answerCallbackQuery->show_alert            =     true;
          $answerCallbackQuery->text                  =     $answerQueryText;
          $messageCorrectionPromise                   =     $tgLog->performApiRequest($answerCallbackQuery);
          break;
      }
      break; // End Y√™u C·∫ßu T√°i R√∫t Th√°ng
    case 'back':
      switch ($arrayQueryData[1]) {
        case 'week':
          $editMessageText                            =     new EditMessageText();
          $editMessageText->chat_id                   =     $queryUserId;
          $editMessageText->message_id                =     $querymsgId;
          $editMessageText->text                      =     "Ch·ªçn plan b·∫°n mu·ªën y√™u c·∫ßu:";
          $arrayInlineKeyBoard    					  =   array();
          $plansArray             					  =   checkDetailPlan($queryUserId);
          foreach($plansArray as $key => $value) {
              $buttonText         					  =         ucfirst($value['ten_plan']) . ' - Tr·∫°ng Th√°i: '. ucfirst($value['tai_dau_tu']) . ' T√°i';
              $arrayInlineKeyBoard['inline_keyboard'][$key][$key]['text']               =   $buttonText;
              $arrayInlineKeyBoard['inline_keyboard'][$key][$key]['callback_data']      =   'request_'.$value['ten_plan'];
          }

          $inlineKeyboard               			  = new Markup($arrayInlineKeyBoard);
          $editMessageText->reply_markup              =     $inlineKeyboard;

          $messageCorrectionPromise                   =     $tgLog->performApiRequest($editMessageText);
          break; // N√∫t Back Tu·∫ßn
        case 'month':
          $editMessageText                            =     new EditMessageText();
          $editMessageText->chat_id                   =     $queryUserId;
          $editMessageText->message_id                =     $querymsgId;
          $editMessageText->text                      =     "Ch·ªçn plan b·∫°n mu·ªën r√∫t Coin: (r√∫t l√£i ho·∫∑c g·ªëc theo th√°ng)";
          $arrayInlineKeyBoard    					  =   	array();
          $plansArray             					  =   	checkDetailPlan($queryUserId);
          foreach($plansArray as $key => $value) {
          	  if(empty($value['yeu_cau_khac'])) {
				$value['yeu_cau_khac'] 	=	"Ch∆∞a c√≥ y√™u c·∫ßu";
			  }
              $buttonText         					  =         ucfirst($value['ten_plan']) . ' - Tr·∫°ng Th√°i: '. ucfirst($value['yeu_cau_khac']);
              $arrayInlineKeyBoard['inline_keyboard'][$key][$key]['text']               =   $buttonText;
              $arrayInlineKeyBoard['inline_keyboard'][$key][$key]['callback_data']      =   'request-month_'.$value['ten_plan'];
          }

          $inlineKeyboard               			  = 	new Markup($arrayInlineKeyBoard);
          $editMessageText->reply_markup              =     $inlineKeyboard;

          $messageCorrectionPromise                   =     $tgLog->performApiRequest($editMessageText);
          break;
        default:
          # code...
          break;
      }
      break; // End Back Button
    default:
      # code...
      break;
  }
}
$loop->run();